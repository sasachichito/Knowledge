# DevOps  
DevOpsはリーン生産方式の原則をITのバリューストリームに応用した結果である。  
  
### DevOpsが生まれた歴史  
```  
1980年代 バリューストリームマッピング、カンバン、トータル生産管理といったテクニックがトヨタ生産方式（TPS）として体系化されリーン（思考）が生まれる  
1997年 Lean Enterprise Instituteが生産以外のバリューストリームに対するリーンの応用の研究を開始  
2001年 アジャイル宣言  
2006年 アジャイルカンファレンスで継続的デリバリーについて発表される  
2008年 アジャイルカンファレンスでインフラストラクチャへのアジャイルの原則の応用についての小セッションが開催  
2009年 ベロシティカンファレンスで"10 Deploys per Day : Dev and Ops Cooperation at Flickr"というプレゼンテーションが行われる  
2009年 "DevOpsDays"というカンファレンス開催（ここでDevOpsという言葉が生まれる）  
2009年 改善のカタ（型）についての著書が出版  
```  
  
# バリューストリーム  
「バリューストリーム」はリーンの基本概念の1つである。バリューストリームとは  
```  
企業が顧客の要求に応えるために着手する一連の活動  
```  
あるいは  
```  
顧客に届ける商品やサービスを設計、生産し、送り届けるために必要な一連の活動で、情報と素材の双方向的なフローを含む  
```  
と定義されている  
  
### ITバリューストリーム  
DevOpsではITにおけるバリューストリーム（ITバリューストリーム）を  
```  
ビジネス上の仮説を定義してから、顧客に価値を送り届ける技術サービスを生み出すまでの間に必要なプロセス  
```  
と定義している。  
このプロセスに対する入力は、ビジネスの目的、コンセプト、アイデア、仮説などを定式化したもので、  
開発が仕事を引き受けバックログに追加した時に始まる。  
  
ITバリューストリームは2つのフェーズに別れる  
```  
設計/開発バリューストリーム... 可変性と不確実性が高くプロセスタイムの変動も大きい（リーン製品開発と似ている）  
テスト/運用バリューストリーム... 可変性と不確実性が低くリードタイムの変動が小さい（リーン生産方式と似ている）  
```  
  
設計/開発バリューストリームとテスト/運用バリューストリームを同時に行い、高速なフローと高品質を実現することを目標とする。  
これが成功するのは小さなバッチサイズで仕事を進め、バリューストリームのあらゆる部分で品質を保証していく時に限られる。  
  
# リードタイムとプロセスタイム  
```  
リードタイム... バックログに入ってから顧客に届くまでの時間  
プロセスタイム... 顧客の要求に着手してから顧客に届くまでの時間  
```  
テスト/運用バリューストリームのリードタイムをデプロイリードタイムと呼称する。  
  
DevOpsではリードタイムとプロセスタイムに加えて完全正確率(%C/A)という第3の重要な指標がある。  
%C/Aは下流の顧客に「そのままの形で使える」仕事を受け取った割合を尋ねればわかる。  
  
# DevOpsの原則：3つの道  
![3つの道](/picture/DevOps.png "3つの道")
### 第1の道
開発→運用→顧客の左から右へのワークフローを高速であること  

### 第2の道
バリューストリームのあらゆるステージで素早くてコンスタントな右から左へのフィードバックフローがあること  

### 第3の道
ダイナミックで統制の取れた科学的なアプローチに基づく実験とリスクテイクを支持し、成功と失敗から組織として学習し教訓を得ていく生産的な高信頼マネジメントの企業文化があること

# 第1の道：フローの原則  
この原則は、開発から運用への作業の流れを速くスムースにする。  
ITバリューストリームでこれを実現するためには、生産のコンテキストでバリューストリームにリーン原則をどのように当てはめたのかを探る。  
  
### 作業の可視化  
ITと生産におけるバリューストリームの大きな違いは、ITの作業は目に見えないことだ。  
生産とは異なり、ITのバリューストリームではフローがどこで遅れているか、ワークセンターの前で仕事が積み上がっているのはどのようなときかを簡単に見ることはできない。  
生産バリューストリームでは在庫部品を物理的に移動しなければならないので、ワークセンター間の作業の移動はよく見えるし、遅い。  
ITで作業を可視化する特に良いプラクティスは  
カンバンボードやスプリント計画ボードなどの作業ボードの利用だ。  
  
### WIPの制限  
WIP（Work In Progress）＝ 仕掛かり  
生産では定期的に作られる生産計画に従って日々の仕事を行う。  
ITの仕事はそれに比べてはるかに流動的であり、日々の仕事はその時点での優先順位によって左右される。  
チケットシステム・システム通知・メール・電話・チャットルーム・エスカレーションなどありとあらゆるコミュニケーション手段から届く急ぎの仕事のリクエストによって決まることも多い。  
  
生産では作業の中断は目で見てよく分かるし中断されにくい。  
それに比べてITワーカーの作業は簡単に中断され悪影響も大きい。  
複数プロジェクトを担当するエンジニアはよくいるが、マルチタスクに付随するタスクスイッチが作業時間に与える悪影響が大きいという研究結果がある。  
  
カンバンボードを使う場合は列に配置するカードの数を制限することでマルチタスクを制限できる。  
つまり各列（ワークセンター）が抱えて良いWIPの上限を決める。  
```  
カンバンの達人Dominica DeGrandis「キューの長さ（すなわちWIP）のコントロールは極めて強力な管理ツールです。  
ほとんどの作業アイテムは、実際には完了までどのくらいかかるかわからないものですが、キューの長さはリードタイムの数少ない指標の一つになります。」  
```  
  
### バッチサイズの縮小  
大きなバッチサイズの仕事は大量のWIPを生み出してしまう。  
各ワークセンターは混乱し、問題が発覚した時の手戻りは大きい。  
10冊のパンフレットを送るときを考えてみる。  
工程は「用紙を折る」「封筒に入れる」「封をする」「切手を貼る」の4行程からなる。  
大バッチ戦略では10冊全てを各工程で完了させていくのに対し、小バッチ戦略では1冊が全行程完了したら2冊目に進む。  
小バッチ戦略は「シングルピースフロー」と呼ばれる。  
小バッチではWIPが減り、リードタイムが短くなり、エラー発見が早まり、手戻りが減る。  
  
ITバリューストリームでのシングルピースフローはバージョン管理への1コミットがテスト・本番デプロイされることである。  
  
### 受け渡しの数の削減  
バリューストリームの先の方にコードを移動させていくためには様々なチームが仕事をしなければならない。  
これはキューの滞留が増えるし、どんなに良い状況でも作業を受け渡しすると情報が失われていく。（解決しようとしている問題や目標など）  
自動化やチーム編成で作業の受け渡し回数を減らす努力をする必要がある。  
  
### 絶えず制約条件を見つけ出して尊重する  
```  
Goldratt博士「どのバリューストリームにも、フローには必ず向きがあり、唯一無二の制約条件があります。  
その制約条件以外に対する改善は幻想に過ぎません。」  
```  
制約条件（ボトルネック）の前にあるワークセンターに改善を加えても、ボトルネックとなっているワークセンターに作業をしてもらうのを待っている仕掛かりの山が早く積み上がるだけである。  
それに対しボトルネックの後のワークセンターを改善しても、ボトルネックを通過してくる仕事を待って飢餓状態になるだけである。  
Goldratt博士はこの問題を解決するために「5つの重点的なステップ」を定義した。  
```  
・システムの制約条件を明らかにする  
・システムの制約条件の能力を最大限に引き出す方法を決める  
・ほかのすべてのことをその決定に従属させる  
・システムの制約条件を最大限に尊重する  
・今までのステップで制約条件が制約条件でなくなったらステップ1に戻る。但し惰性で制約条件を作ってはならない。  
```  
  
### バリューストリームからムダと苦痛を取り除く  
トヨタ生産方式の開拓者の一人である新郷重夫は、ムダは企業が生き残っていくための最大の脅威になると考えていた。  
新郷は生産のムダとして在庫・作り過ぎ・加工のしすぎ・運搬・手持ち・動作・不良の7つを定義している。  
リーンの解釈ではムダとは「顧客が必要とする範囲、支払うつもりのある範囲を超えた材料やリソースの利用」とし、  
"ムダの削減"という言い方をすると屈辱的で非人間的な響きがあることに注目し、  
「組織の目標達成のための継続的に学習することを通じて日常業務から苦痛と重労働を取り除くこと」と言い換えている。  
```  
・部分的に完成した仕事：バリューストリーム内の完成しておらず（例えばレビューされていない要求文書や変更要請）、キューに溜まっている仕事（例えばQAのレビューやサーバー管理チケット待ち）。  
・余分な処理：顧客のために付加価値を生まないプロセス内の余分な作業。ワークセンターで使われていないドキュメントや、出力に付加価値を追加しないレビューや承認。余分な処理は労力を増やし、リードタイムを長引かせる。  
・余分な機能：サービスに組み込まれた組織や顧客が必要としていない機能（例えば「金メッキ」）。余分な機能は製品を複雑にするとともに、テスト、管理の仕事を増やしてしまう。  
・タスクの切り替え：複数のプロジェクト、バリューストリームを割り当てられた人は、コンテキストの切り替えや作業間の依存関係の管理のために、バリューストリームに余分な時間と労力を投入する。  
・待機：作業の間に遅れが生じると、下流側は待機しなければ仕事を完成させることができなくなる。遅延によってリードタイムが延び、顧客に価値を届けるのが遅れる。  
・動作：あるワークセンターから次のワークセンターに情報や材料を移転するために必要な労力。動作のムダは、頻繁にコミュニケーションを取らなければならない人々が同じ場所にいないときに生まれる。作業の受け渡しも動作のムダを生み出し、曖昧さを取り除くためにコミュニケーションを余分に必要とすることが多い。  
・不良：情報、材料、製品の不良、消失、不明確さは、それらの問題の解決のために労力を必要とするので、ムダを生む。不良を作り出してから見つけるまでの時間が長引けば長引くほど、不良の解決が難しくなる。  
・非標準的な作業や手作業：再現不可能なサーバー、テスト環境、構成の利用などのように、他者の非標準的な作業や手作業を必要とすること。運用に対する依存事項はすべて自動化、セルフサービス化して、オンデマンドで得られるようにしたいところだ。  
・超人的な作業：組織が目標を達成するために、個人やチームが不合理なことをしなければならなくなり、それが日常業務の一部になることさえあること（例えば、毎晩のように午前2時に本番環境で問題が起きたりソフトウェアをリリースするたびに数百もの作業チケットを作らなければならなかったりすること）。  
```  
これらのムダや苦痛（超人的な作業が必要になるあらゆる箇所）を可視化し、緩和、削減するために必要なことを系統的に行って  
スピーディーなフローをという目標を達成することが必要だ。  
  
# 第2の道：フィードバックの原則  
この原則は、バリューストリームのすべてのステージで右から左に早くコンスタントにフィードバックを返せるようにする。  
  
### 複雑なシステムにおける安全な作業  
複雑なシステムではエラーは必然であり不可避なので、生産であれITであれ破滅的な結果を引き起こすはるか手前の段階で障害を発見できるという自信のもとで、  
恐怖を感じずに仕事ができる作業システムを設計しなければならない。  
完全に安全なシステムの設計は私たちの能力を超えているものの、次の4つ条件を満たせば複雑なシステムでより安全に作業することができる。  
```  
・設計や運用の問題が明らかになるような形で複雑な仕事を管理している。  
・問題が発生したときに組織が一丸となって解決に当たり、新しい知識をすばやく構築して行く。  
・組織の一部が新しく獲得したローカルな知識を組織全体でグローバルに活用する。  
・リーダーたちが、この種の能力を継続的に成長させていくような人々を次のリーダーとして育てていく。  
```  
  
### 発生と同時に問題を知る  
作業システムにフィードバックとフィードフォワードのループを作る。  
私たちの目標は、製品管理、開発、品質保証（QA)、情報セキュリティ、運用からなるITバリューストリーム全体のどこで仕事をしていても、  
スピーディなフィードバック/フィードフォワードループが働くようにすることだ。  
  
### 新しい知識を作り上げるために組織が一丸となって問題に当たる  
当然ながら想定外のことは発見しただけでは不十分である。問題が起きたら、  
問題解決のために必要な人をすべて動員し、組織をあげて問題に対処しなければならない。  
  
この原則の手本になるのはトヨタのアンドンである。すべてのワークセンターの上に紐が吊るされており、何かまずいことが起きたらそれを引っ張るよう、作業者、管理者全員が教育されている。  
例えば部品不良、必要な部品がない、作業が説明よりも長くかかるという場合だ。  
アンドンの紐が引かれると、チームリーダーに警告が送られ、彼は直ちに問題解決のために動く。規定の時間内（例えば55秒）で問題が解決できなければ  
本番生産ラインは停止され、適切な対策が見つかるまで組織をあげて問題解決に取り組む。  
問題は回避したり、「もっと時間があるとき」に解決を先送りにしたりせずに、一丸となってすぐに問題を解決する。  
一丸となっての解決が必要なのは次のような理由からだ。  
```  
・問題が下流に波及するのを防ぐ。下流まで波及すれば、問題解決のためにかかる費用や労力は指数的に増え、技術的負債が蓄積していってしまう。  
・ワークセンターが新しい仕事を始めるのを防ぐ。仕事を始めれば、システムに新しいエラーを持ち込むことになるだろう。  
・その問題が解決されなければ、ワークセンターは次の操業（例えば55秒後）でも同じ問題を起こし、必要な修理、作業が増える。  
```  
ITバリューストリームでスピーディなフィードバックを実現するためには、アンドンの紐と一丸となっての対策に相当するものを作り出さなければならない。  
そのためには、本番環境のインシデントであれ、バリューストリームの早い段階でのエラーであれ、何か問題を起こしたときにアンドンの紐を引っ張っても非難されず、  
むしろそうすることが奨励されるような文化を作る必要がある。  
問題が起きてアンドンの紐が引っ張られたら、私たちは一丸となってその問題の解決に当たり、解決するまで新しい仕事を始めてはならない。  
それによりバリューストリームに属するすべての人々（特にシステムエラーの原因を作った人）にすばやくフィードバックを送流。  
  
新しい仕事の開始を禁止することにより、ITバリューストリームのシングルピースフローである継続的インテグレーション及び継続的デプロイが成立する。  
継続的ビルドとインテグレーションテストに合格した変更は、すべて本番環境にデプロイされる。  
変更がテストのどれかで不合格になったときには、アンドンの紐が引かれ、組織が一丸となって解決に当たる。  
  
