# 分散システムデザインパターン  
  
## シングルノードパターン  
  
### サイドカー  
アプリを拡張・改善するパターン。  
サイドカーコンテナは様々なアプリに適用できるようにパラメータ化すること。  
  
```  
例1）HTTPS化  
SSLプロキシコンテナをアプリと同一のPodにデプロイする。  
既存のアプリに手を加えずに対応できる。  
```  
```  
例2）動的な設定変更の実現  
クラウド上の設定保存サービスとローカルの設定ファイルを同期させ、  
動的に変更をアプリに適用させるコンテナをアプリと同一のPod内にデプロイする。  
```  
```  
例3）PaaSの構築  
アプリの実行環境コンテナと、Git同期コンテナを同一Podにデプロイする。  
ソースコードが共有ディレクトリに配置されることでPaaSを実現する。  
```  
  
### アンバサダー  
アプリの外部システムへのリクエストを仲介するパターン。  
  
```  
例1）シャーディングされたDB接続の簡易化  
アプリからリクエストされ、適切なシャードを選択しにクセスするコンテナをアプリと同一Podにデプロイする。  
アプリ内でシャードを選択するロジックを書く必要がなくなりビジネスロジックに専念できる。  
```  
```  
例2）サービスブローカの実現  
サービスディスカバリ（サービスブローカに問い合わせて目的のサービスを探索する）コンテナをアプリと同一Podにデプロイする。  
アプリ内にサービスディスカバリのロジックを書く必要がなくなりビジネスロジックに専念できる。  
```  
```  
例3）カナリア・ABテストの実現  
アプリから新システムへ本番のトラフィックをteeするコンテナをアプリと同一Podにデプロイする。  
teeであるためアプリには影響を与えずに新システムの動作を確認できる。  
teeコンテナをマイクロサービスとして別Podにしても良いが、アンバサダとしてクライアント側に配置すると比較的運用管理が楽になる。  
```  
  
### アダプター  
外部システムが要求するインターフェースをアプリから分離するパターン。  
  
```  
例1）監視の実現  
標準的な監視システム（Prometheusなど）に独自のアプリの情報を提供するためのアダプタコンテナをアプリと同一Podにデプロイする。  
独自のアプリがPrometheusの要求するインターフェースを満たしていなくても、アダプタコンテナがその違いを吸収する。  
アプリが自身のビジネスロジックに専念できる。  
```  
```  
例2）ロギングの実現  
標準的なロギングツール（Fluentdなど）に独自のアプリの情報を提供するためのアダプタコンテナをアプリと同一Podにデプロイする。  
ログのフォーマットや内容、タイミングをアダプタコンテナが管理してくれる。  
```  
```  
例3）ヘルスモニタの実現  
独自・既存アプリに対して独自のヘルスチェックを行うアダプタコンテナをアプリと同一Podにデプロイする。  
アプリはビジネスロジックに専念でき、アダプタコンテナは広く再利用可能となる。  
```  
  
## マルチノードパターン  
  
### レプリケーション  
### シャーディング  
### スキャッタ・ギャザー  
### デコレーター  
### イベントベースパイプライン  
### オーナーシップ  
クラスタにおいてマスタ（リーダー）が常に区別されていなければならない場合のマスタ選出パターン。  
マスタが更新系を担い、スレーブがレプリケーションする構成への適用が一般的。  
```
※補足
スレーブはマスタのホスト名を静的に認識している。そのためマスタをレプリケーションやシャーディングで冗長化し必要に応じてスケールしたとしても  
スレーブはスケールされた新たなマスタを認識する必要がある。  

データをマスタ・スレーブ共有のデータベースに格納すればこのパターンは必要ないが、データベース障害時にマスタ・スレーブのどちらも機能停止することを避けられない。
```

# バッチ処理パターン  
