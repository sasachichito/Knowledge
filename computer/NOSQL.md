# NOSQL  
NOSQLとは、Not Only SQLの略で「SQLだけでは十分でない」という意味である。  
これは"SQL(RDB)ではビッグデータ対応には"十分でない、という意味である。  
  
# ビッグデータ対応  
ビッグデータとはサイズの小さなデータが膨大に集まり、大きなデータの塊になったものを指す。  
単に大きなファイルは「ラージオブジェクト」と呼ばれる。  
  
「ビッグデータ対応」とは3Vに対応するということである。  
```  
3V  
・膨大な量 = Volume  
・速さ = Velocity  
・多様性 = Variety  
```  
  
### 膨大な量 = Volume  
ビッグデータを格納・処理することはハードウェアの性能向上（ハードディスクを大きく速いものにする）だけでは到底追いつけない。  
安価ながらそれなりの性能を持ったハードウェアを複数ならべ、あたかも一つの最高性能の装置のように扱う必要がある。  
  
### 速さ = Velocity  
ビッグデータを高速に処理することはハードウェアの性能向上だけでは到底追いつけない。  
こちらも分散して処理する仕組みが必要である。  
  
### 多様性 = Variety  
ビッグデータはデータの形が多種多様に変化していくもので、複雑なデータ構造と、複雑な相互関係を持つ。  
これらに対応できる仕組みが求められる。  
  
RDBは単一ハードウェアで稼働する場合は最適だが、データを分散させるには不向きだ。  
また多種多様なデータにおいてRDBでいう構造化は不可能である。  
結果、NOSQLが求められた。  
  
# 分散システム  
分散システムとは「クラスタ」構成のシステムを指す。  
クラスタとは、安価ながらそれなりの性能を持ったハードウェアを複数ならべ、あたかも一つの最高性能の装置のように扱う構成をいう。  
  
つまり分散システムとは何らかの性能を最高レベルに達させたものであり、それがどのような性能なのかはコンテキストによって異なる。  
  
NOSQLの分散システムで実現した最高レベルの性能は、「膨大なデータの取り扱い」「信頼性」の二つである。  
  
### 膨大なデータの格納・処理  
1. シャードのクラスタを構成（シャーディング）することで実現  
  
利用される概念・技術  
```  
・拡張性を考慮したシャーディングアルゴリズム  
・シャーディングキー選定  
```  
  
### 信頼性  
1. レプリカのクラスタを構成（レプリケーション）することで実現  
2. 同一のデータを複数ノードにシャーディングすることで実現  
  
利用される概念・技術  
```  
・CAP定理  
・整合性の調整  
・CAS操作  
・マスタ / P2P アーキテクチャ  
・マスタの特性・選出パターン（マスタ型アーキテクチャの場合）  
```    
  
# NOSQLのデータモデル  
### SQLのデータモデル  
表の形でデータ構造を設計し、正規化でデータの冗長性と不整合を排除している。  
これにより個々のデータは定型化され、相互の関係性が明確に定義される。  
データの発生よりも先にデータ構造をテーブルの形に固定しておくことで、その関係性に揺らぎが生じないようになっている。  
  
### キー・バリュー（KVS）型NOSQLのデータモデル  
テーブルや関係性を定義せずに、「キー」と「バリュー」の組み合わせからなるシンプルなデータモデル。  
キーによりバリューを一意に識別する。  
  
データが増えるに従って縦方向（行）に伸びていく。  
  
特徴  
```  
・データモデルがシンプル  
SQLのようなスキーマがなく、多くはキーはstring, バリューはBLOB（Binary Large OBject : ブロブ）でもつ。  
  
・スケールアウトに最適  
データ間の関係性がないため整合性を保つための排他ロックが不要なため、複数サーバーでデータをシャーディングすることが容易である。  
  
・レプリケーションが可能  
シャーディングだけではなくレプリケーションを考慮したNOSQL製品もある。  
```  
  
### カラム指向型NOSQLのデータモデル  
キー・バリュー型を少し高度にしたデータモデルで、1つのキーが1つのバリューと対になるのではなく、  
複数のキー・バリューを1キー（行キー）でグループ化するデータモデル。個々のキー・バリューをカラムと呼んでいる。  
グループ化されたカラム群と行キーを合わせてカラムファミリーと呼ぶ。  
  
テーブルではないのでキー毎のカラム数は固定されておらず、動的に追加できる。  
また全てのカラムにバリューが挿入されていないことも許容される。  
  
データが増えるに従って縦方向（行）と横方向（列）に伸びていく。  
  
特徴  
```  
カラムファミリー名と行キーは予め定義しておく必要があるが、その中のカラム（キー・バリュー）は動的に増やしていくことができる。（横方向に伸びていく）  
例えばカラム名（つまりキー）をタイムスタンプにして追加していくなど。  
当然、行キーが追加されていくこともある。（縦方向に伸びていく）  
  
キー・バリューと同様にスケールアウトに最適である。  
```  
  
### ドキュメント指向型NOSQLのデータモデル  
JSONやXMLなどの書式で記述されたドキュメントの形でデータを管理するデータモデル。  
  
特徴  
```  
内容をクエリできる  
```  
  
### グラフ型NOSQLのデータモデル  
データとデータのつながりを管理できるデータモデル。  
  
特徴  
```  
ノード・リレーションシップ・プロパティを使って経路を書くこと（グラフ化）を機能として提供している  
```  
  
# NOSQLのアーキテクチャ  
NOSQLのアーキテクチャは大きく、GoogleのBigtable系と、AmazonのDynamo系の2種に分類される。  
  
### Google Bigtable系  
GoogleのBigtable系は「マスタ型」と呼ばれ、一つのマスタノードが、配下にある多数ノードを管理する構成をとる。  
マスタノードがダウンする障害にはマスタ選出パターンで備える。  
  
CP（CAP定理）システムであり、必ず整合性が保たれるが可用性は低い。（強い整合性）  
書き込まれたデータを同期的にノード間で複製している。  
  
### Amazon Dynamo系  
AmazonのDynamo系は「P2P」と呼ばれ、マスタノードに該当するものは存在せず、全てのノードが対等にお互いを管理し合う構成をとる。  
こちらは単一障害点がないというメリットがある。  
  
AP（CAP定理）システムであり、高い可用性を持つが結果整合性である。（弱い整合性）  
各ノードが更新を受け付け、ノード間で差異があった場合にDBMS側で修復する。  
  
### CAP定理  
分散システムにおける定理。  
```  
CAP定理の文脈におけるDBMSの分散システムは、レプリカのクラスタを意味する。  
マイクロサービスの分散システムとは、各サービスが互いに連携して1業務を実現していることを意味する。  
```  
今回はDBMSの分散システムの話。  
  
ノードA・Bがあったとき、  
```  
・クライアント1がAに書き込み→AはBに連携→Bも書き込み→Aがクライアント1にレスポンス返す  
・クライアント2がBにクライアント1が更新したデータの参照を要求する→Bがクライアントに最新データを渡す  
```  
という流れを守ることにより整合性を保ち、クライアント1,2の可用性を維持している。(これはABが分断されることを考慮していない）  
  
もしネットワーク障害によりAとBの間が分断された場合、この構成は破綻するためABを停止するしかない。  
つまり分断耐性（P）が無い。(RDBはこのCAシステム)  
  
ABが分断された時にサービスを停止しない（分断耐性を持たせる）にはどうすればよいか。このときがCPとAPへの分かれ道となる。  
**・整合性を担保するCPシステムにする**  
```  
AかBどちらかを停止する。  
例えばBを停止してクライアント2の参照・書き込みを失敗させることで、Aのクライアント1は常に整合性の取れた最新のデータで処理を続行できる。  
しかし当然クライアント2の可用性は失う。  
```  
**・可用性を担保するAPシステムにする**  
```  
AとBを稼働させ続ける。  
これによりクライアント1・2の可用性を維持したままサービスを続行できる。  
しかしクライアント1は2が書き込んだデータを参照できないし、その逆も然りなのでデータの整合性は失われる。  
```  
  
### 整合性の調整  
CAP定理はあくまで理論的に割り切ったものであり、実際には整合性は調整することができる。  
それにはQuorum（クォーラム）という基本概念を用いる。  
```  
Quorum : R + W > N の場合には整合性を保証できる。  
  
R（読み込み数）とW（書き込み数）の合計がN（ノード数）より大きい場合、必ず最新のデータを見つけることができるということである。  
例えば  
3ノード(ABC)あったとき、書き込みを2ノード(AB)に行い、読み込みを2ノード(BC)に行うと、必ず書き込まれたデータがあるノード(B)にアクセスすることができる。  
```  
  
Quorumの整合性調整により、サーバーダウンやネットワーク障害で1ノードと通信できなくなったときもサービスを稼働させ続け（分断耐性を実現し）、  
クライアントは2ノードにアクセスできるので可用性が保たれ、かつ整合性までも確保している。（この構成では2ノードダウンには耐えられないが）  
  
当然、書き込みや読み込みの処理が大きくなるため、性能とのトレードオフになる。  
  
### データのバージョン管理  
複数クライアントから同時に書き込みがありその内容が衝突する場合、どうやってデータのバージョンを管理し、最新バージョンに落ち着かせるのか。  
方法としては「タイムスタンプ」と「ベクタークロック」がある。  
  
##### タイムスタンプ  
その名の通り時間的な後先に従ってバージョン管理し、「新しいものが勝つ」というシンプルなルールを適用する。  
しかし完全に同時に書き込まれた場合や、ノード間でタイムスタンプの同期が難しい場合は「ベクタークロック」を用いる。  
  
##### ベクタークロック  
省略  
  
### CAS操作  
強い整合性を保証するNOSQLの中にはCAS（Check And Swap）という操作をサポートするものもある。  
```  
CAS操作 :   
ある値を更新する際に、その値を自分のプロセスが読み込んだ後に、別のプロセスによって更新されていないことを確認して  
それが確認できた場合にのみ自身の更新を適用するというオペレーション。  
```  
  
# Hadoop  
Hadoopとは複数のソフトウェアを包含するフレームワークであり、2つの主要プロダクトで構成される。  
HadoopはNOSQLではない。  
  
**・hadoop HDFS**  
マスタ型の分散ファイルシステム。  
NOSQLとの違いは一度のデータ転送量を重要視し、レスポンスタイムが低くても問題ない設計になっていること。  
  
**・hadoop Map Reduce**  
バッチ処理システム。  
  
# NOSQL製品の分類  
### 分類  
横軸：マスタ型, P2P型, イネーブラ型(オンメモリ), イネーブラ型(オンディスク)  
縦軸：  
キー・バリューストア(KVS)  
カラム指向型データストア  
グラフ型データストア  
ドキュメント指向型データストア  
  
イネーブラ型とは、他のデータベースと組み合わせたときに特段の利用効果を得られるものを指す。  
イネーブラの意味は成功要因。  
もちろん単体でも利用できる。  
  
# キー・バリューストア(KVS)  
### マスタ型  
**・Hibari**  
```  
・チェインレプリケーションによる強い整合性  
```  
  
### P2P型  
**・Dynamo**  
```  
・結果整合性  
・バージョン管理をクライアント側に実装  
・DynamoはAmazon社外で手に入れることはできないがAWS上でDynamoDBとして似た機能を提供  
```  
**・Voldemort**  
**・Riak**  
  
### イネーブラ型（オンメモリ）  
**・Memcached**  
```  
・あるサーバーがDBからキャッシュしたデータを、複数サーバーからアクセスできるようにする。  
・ノード間の複製は行なっていない。  
```  
**・Redis**  
```  
・様々なデータ構造を持てる（データストラクチャ・ストアとも呼ばれる）  
・複製のためのマスタ・スレーブ型  
・Redis では公式から Replication, Sentinel, Cluster の3つの冗長構成が選べる https://hobik-site.blogspot.com/2018/09/redisreplicationsentinelcluster.html  
・結果整合性  
・定期的にメモリからディスクに書き出せる  
```  
**・Scalaris**  
```  
・Quorumにより強い結果整合性を保証  
```  
  
### イネーブラ型（オンディスク）  
  
# カラム指向型データストア  
### マスタ型  
**・HBase**  
  
### P2P型  
**・Cassandra**  
```  
・Dynamoの完全な分散設計とBigtableのカラムファミリ型データモデルが一緒になったもの  
・整合性の調整が可能  
```  
  
# グラフ型データストア  
### マスタ型  
### P2P型  
  
# ドキュメント指向型データストア  
### マスタ型  
**・CouchDB**  
**・MongoDB**  
```  
・書き込みはマスタ、読み出しはスレーブから行う  
```  
  
# NOSQLの選択基準  
## 技術特性  
用途に応じて求められる技術特性を、整合性・可用性・拡張性・柔軟性・機能性・永続性に分けて選定する。  
  
### 整合性を重視する場合  
### 可用性を重視する場合  
### 拡張性を重視する場合  
### 柔軟性を重視する場合  
### 機能性を重視する場合  
### 永続性を重視する場合  
  
## 性能面  
書き込み性能、読み出し性能、拡張性、弾力性の観点からその性能で選定する。  
  
## ビジネス適用  
商用サポートや商用パッケージ、OSSであればコミュニティの充実度から選定する。  
