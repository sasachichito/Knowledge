# メモ
```
Tx = トランザクション

目的①～④：ACID特性
目的⑤～⑥：排他制御

目的①：Txのロールバックを可能にする（原子性保証）
目的②：Tx完了時にはデータ不整合なしとする（一貫性保証）
目的③：Txの途中結果を参照させない（独立性保証）
目的④：Txの完了結果は障害が発生してもしても失わない（耐久性保証）
目的⑤：ダーティーライトを回避する（排他制御）
目的⑥：ロストアップデートを回避する（排他制御）


目的①：Txのロールバックを可能にする（原子性保証）
手段：RDBの使用
手段（分散システム）：サーガ＋カウンターメジャー
具体例：


目的⑤：ダーティーライトを回避する（排他制御）
手段：悲観ロック
手段（分散システム）：リクエストシャーディング、外部ロックテーブル（Redis等）
具体例：


目的⑥：ロストアップデートを回避する（排他制御）
手段：楽観ロック
手段（分散システム）：リクエストシャーディング、外部ロックテーブル（Redis等）
参考：ダーティライトとロストアップデート

...

https://qiita.com/tenn25/items/33b5ff0a5d1505dae3b4
```

# 排他制御とは
以下の表は排他制御の立ち位置を示すものである。

| 信頼のあるトランザクション処理に求められるもの | 内容一覧 | 目的 | RDB | Cassandra | 備考 |
----|---- |---- |---- |---- |---- 
| 排他制御(同時実行制御) | 楽観的排他制御 | 共有データへの同時アクセスにより、片方の更新処理がなかったことになる現象を回避する(ロストアップデートを回避する) | 可能 | 可能※Cassandraがサポートする軽量トランザクションにより実現可能だが、レイテンシが4倍になる | 参考リンク https://docs.datastax.com/ja/dse/5.1/dse-arch/datastax_enterprise/dbInternals/dbIntLtwtTransactions.html |
| " | 悲観的排他制御 | 同上 |可能|可能 ※別のOSSと組み合わせて実現可能だが、レイテンシ悪化＋場合によっては単一障害点あり。|参考リンク(ぐるなびの導入事例) https://www.slideshare.net/haketa/cassandra-cassandra-summit2014jpn|
| ACID特性 | 原子性 | 一連の処理が全て実行されるか、全てされないかのどちらかであることを担保する(ロールバックを実現する) |持つ|持たない||
| " | 一貫性 |  |持つ|持つ||
| " | 独立性 | トランザクションの途中の状態を観測されないことを担保する(ダーティリード、ファジーリード、ファントムリード※を回避する) ※関連リンク : https://qiita.com/momotaro98/items/ad859ec2934ee98540fb |持つ|持たない||
| " | 永続性 |  |持つ|持つ||

# まとめ
信頼のあるトランザクション処理を行うシステムでは、排他制御を行い、ACID特性を持たせる必要がある。
排他制御ができていないとロストアップデートが発生する。排他制御方法には楽観的排他制御と悲観的排他制御の2種類あり、それぞれ楽観ロック、悲観ロックと呼ぶ。
参考リンク：https://qiita.com/NagaokaKenichi/items/73040df85b7bd4e9ecfc
